# scan-report.py
Reports discovered vulnerabilities by Cloud One Image Security. If multiple scans were taken out for the requested image, the latest scan is evaluated.

First, create your config.yml by
```shell
cp config.yml.sample config.yml
```
and define the values.
Sample:
```
dssc:
  service: "<smart check url:port>"
  username: "<smart check username>"
  password: "<smart check password>"

repository:
  name: "<repository name>"
  image_tag: "<image tag, e.g. latest>"

criticalities:
  - defcon1
  - critical
  - high
  - medium
```

Run the reporter by
```shell
python3 scan-report.py
```

Optional command line arguments:
```
--config_path, type=str, help="path to config.yml"
--name, type=str, help="image name"
--image_tag, type=str, help="image tag"
--out_path, type=str, help="output directory"
--service, type=str, help="image security url without https://"
--username, type=str, help="username"
--password, type=str, help="password"
```

Output created:
* Findings by Smart Check as PDF
* Vulnerabilities sorted
  * AV: Network, Severity: Critical (including detailed info)
  * AV: Network, Severity: High  (including detailed info)
  * The rest (CVE and link only)

Example:
![alt text](https://github.com/mawinkler/vulnerability-management/blob/master/cloudone-image-security/images/c1-app-sec-djangonv.png "Django")


## Container Variant
Build
```shell
docker build -t scan-report .
```
Run
```shell
docker run --mount type=bind,source="$(pwd)",target=/usr/src/app scan-report --name <image_name> --image_tag <image_tag>
```

## Pipeline Integration
Scripted pipeline example:
```
parallel (
  "Test": {
    echo 'All functional tests passed'
  },
  "Check Image (pre-Registry)": {
    try {
      smartcheckScan([
        imageName: "${REPOSITORY}:${BUILD_NUMBER}",
        smartcheckHost: "${DSSC_SERVICE}",
        smartcheckCredentialsId: "smartcheck-auth",
        insecureSkipTLSVerify: true,
        insecureSkipRegistryTLSVerify: true,
        preregistryScan: true,
        preregistryHost: "${DSSC_REGISTRY}",
        preregistryCredentialsId: "preregistry-auth",
        findingsThreshold: new groovy.json.JsonBuilder([
          malware: 0,
          vulnerabilities: [
            defcon1: 0,
            critical: 0,
            high: 0,
          ],
          contents: [
            defcon1: 0,
            critical: 0,
            high: 0,
          ],
          checklists: [
            defcon1: 0,
            critical: 0,
            high: 0,
          ],
        ]).toString(),
      ])
    } catch(e) {
      withCredentials([
        usernamePassword(
          credentialsId: 'smartcheck-auth',
          usernameVariable: 'SMARTCHECK_AUTH_CREDS_USR',
          passwordVariable: 'SMARTCHECK_AUTH_CREDS_PSW'
        )
      ]) { script {
        docker.image('mawinkler/scan-report').pull()
        docker.image('mawinkler/scan-report').inside("--entrypoint=''") {
          sh """
            python /usr/src/app/scan-report.py \
              --config_path "/usr/src/app" \
              --name "${REPOSITORY}" \
              --image_tag "${BUILD_NUMBER}" \
              --out_path "${WORKSPACE}" \
              --service "${DSSC_SERVICE}" \
              --username "${SMARTCHECK_AUTH_CREDS_USR}" \
              --password "${SMARTCHECK_AUTH_CREDS_PSW}"
          """
          archiveArtifacts artifacts: 'report_*.pdf'
        }
        error('Issues in image found')
      } }
    }
  }
)
```

## Requirements
* Python3
* fpdf, PyYAML, requests, simplejson, urllib3
