#/bin/bash
# ##############################################################################
# Pulls an image, initiates a scan with Smart Check and creates a PDF report
# ##############################################################################
TARGET_IMAGE=alpine
TARGET_IMAGE_TAG=latest
DSSC_REGISTRY=smartcheck-registry-108-129-65-162.nip.io
DSSC_SERVICE=smartcheck-108-129-65-162.nip.io
DSSC_USERNAME=admin
DSSC_PASSWORD=TrendM1cr0
DSSC_REGISTRY_USERNAME=reguser
DSSC_REGISTRY_PASSWORD=TrendM1cr0

docker pull ${TARGET_IMAGE}:${TARGET_IMAGE_TAG}

docker run -v /var/run/docker.sock:/var/run/docker.sock \
  deepsecurity/smartcheck-scan-action \
  --image-name "${TARGET_IMAGE}:${TARGET_IMAGE_TAG}" \
  --preregistry-host="$DSSC_REGISTRY" \
  --smartcheck-host="$DSSC_SERVICE" \
  --smartcheck-user="$DSSC_USERNAME" \
  --smartcheck-password="$DSSC_PASSWORD" \
  --insecure-skip-tls-verify \
  --preregistry-scan \
  --preregistry-user "$DSSC_REGISTRY_USERNAME" \
  --preregistry-password "$DSSC_REGISTRY_PASSWORD"

docker run mawinkler/scan-report:dev -O \
  --name "${TARGET_IMAGE}" \
  --image_tag "${TARGET_IMAGE_TAG}" \
  --service "${DSSC_SERVICE}" \
  --username "${DSSC_USERNAME}" \
  --password "${DSSC_PASSWORD}" > report_${TARGET_IMAGE}.pdf
