#!/bin/bash
# ##############################################################################
# Queries the Kubernetes cluster for the images of the currently runnind pods
# and initiates scans via Smart Check
# ##############################################################################
SMARTCHECK_HOST="<smart check url:port>"
SMARTCHECK_USER="<smart check username>"
SMARTCHECK_PASSWORD="<smart check password>"
PREREGISTRY_HOST="<smart check preregistry url:port>"
PREREGISTRY_USER="<smart check preregistry username>"
PREREGISTRY_PASSWORD="<smart check preregistry password>"

# IMAGES=$(kubectl get pods --all-namespaces -o jsonpath="{..image}" | tr -s '[[:space:]]' '\n' | sort -u)
# for i in $IMAGES ; do
#       docker pull $i
# done

kubectl get pods --all-namespaces -o jsonpath="{..image}" | \
  tr -s '[[:space:]]' '\n' | sort -u | xargs -I {} \
  docker pull {}

for i in $(docker image list --format "{{.Repository}}") ; do
  eval docker run -v /var/run/docker.sock:/var/run/docker.sock \
    deepsecurity/smartcheck-scan-action \
    --image-name "$i" \
    --preregistry-host="${PREREGISTRY_HOST}" \
    --smartcheck-host="${SMARTCHECK_HOST}" \
    --smartcheck-user="${SMARTCHECK_USER}" \
    --smartcheck-password="${SMARTCHECK_PASSWORD}" \
    --insecure-skip-tls-verify \
    --preregistry-scan \
    --preregistry-user "${PREREGISTRY_USER}" \
    --preregistry-password "${PREREGISTRY_PASSWORD}" \
    &>/dev/null & disown
done
